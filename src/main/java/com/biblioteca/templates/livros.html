<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Livros - Sistema de Biblioteca</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .card-modern {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }

        .table-modern thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="fw-bold"><i class="bi bi-book text-success"></i> Gerenciar Livros</h2>
            <p class="text-muted">Cadastro e controle do acervo bibliográfico</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-gradient btn-lg" data-bs-target="#modalNovoLivro" data-bs-toggle="modal">
                <i class="bi bi-plus-circle"></i> Novo Livro
            </button>
        </div>
    </div>

    <!-- Cards Estatísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card card-modern text-center">
                <div class="card-body">
                    <i class="bi bi-book text-primary" style="font-size: 2rem;"></i>
                    <h3 class="mt-2" id="totalLivros">-</h3>
                    <p class="text-muted mb-0">Total de Livros</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-modern text-center">
                <div class="card-body">
                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                    <h3 class="mt-2" id="totalDisponiveis">-</h3>
                    <p class="text-muted mb-0">Disponíveis</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-modern text-center">
                <div class="card-body">
                    <i class="bi bi-arrow-left-right text-warning" style="font-size: 2rem;"></i>
                    <h3 class="mt-2" id="totalEmprestados">-</h3>
                    <p class="text-muted mb-0">Emprestados</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-modern text-center">
                <div class="card-body">
                    <i class="bi bi-collection text-info" style="font-size: 2rem;"></i>
                    <h3 class="mt-2" id="totalExemplares">-</h3>
                    <p class="text-muted mb-0">Total Exemplares</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela -->
    <div class="card card-modern">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 table-modern">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Título</th>
                    <th>Autor</th>
                    <th>ISBN</th>
                    <th>Ano</th>
                    <th>Disponíveis</th>
                    <th>Categorias</th>
                    <th class="text-center">Ações</th>
                </tr>
                </thead>
                <tbody id="tabelaLivros">
                <tr>
                    <td class="text-center py-4" colspan="8">
                        <div class="spinner-border text-primary"></div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Novo Livro -->
<div class="modal fade" id="modalNovoLivro" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius: 15px;">
            <div class="modal-header"
                 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Novo Livro</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <form id="formNovoLivro">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label fw-bold" for="inputTitulo">Título</label>
                            <input class="form-control" id="inputTitulo" name="titulo" required type="text">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold" for="inputAnoPublicacao">Ano Publicação</label>
                            <input class="form-control" id="inputAnoPublicacao" max="2100" min="1000"
                                   name="anoPublicacao" required
                                   type="number">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold" for="inputAutor">Autor</label>
                            <input class="form-control" id="inputAutor" name="autor" required type="text">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold" for="inputIsbn">ISBN</label>
                            <input class="form-control" id="inputIsbn" name="isbn" pattern="[0-9-]+" required
                                   type="text">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold" for="inputQuantidadeDisponivel">Quantidade
                                Disponível</label>
                            <input class="form-control" id="inputQuantidadeDisponivel" min="0"
                                   name="quantidadeDisponivel" required type="number">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold" for="selectCategorias">Categorias</label>
                            <select class="form-select" id="selectCategorias" multiple name="categorias" size="3">
                            </select>
                            <small class="text-muted">Segure Ctrl para múltiplas</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
                <button class="btn btn-gradient" onclick="salvarLivro()" type="button">
                    <i class="bi bi-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Livro -->
<div class="modal fade" id="modalEditarLivro" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius: 15px;">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Livro</h5>
                <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarLivro">
                    <input id="editIdLivro" type="hidden">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label fw-bold" for="editTitulo">Título</label>
                            <input class="form-control" id="editTitulo" required type="text">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold" for="editAno">Ano</label>
                            <input class="form-control" id="editAno" max="2100" min="1000" required type="number">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold" for="editAutor">Autor</label>
                            <input class="form-control" id="editAutor" required type="text">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold" for="editQuantidade">Quantidade</label>
                            <input class="form-control" id="editQuantidade" min="0" required type="number">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
                <button class="btn btn-warning" onclick="atualizarLivro()" type="button">
                    <i class="bi bi-check-lg"></i> Atualizar
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function carregarLivros() {
        fetch('/api/livros')
            .then(response => response.json())
            .then(livros => {
                const tbody = document.getElementById('tabelaLivros');
                tbody.innerHTML = '';

                let disponiveis = 0, totalExemplares = 0;

                livros.forEach(livro => {
                    disponiveis += livro.quantidadeDisponivel > 0 ? 1 : 0;
                    totalExemplares += livro.quantidadeDisponivel;

                    const categorias = Array.from(livro.categorias || []).join(', ');
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                            <td>${livro.idLivro}</td>
                            <td>${livro.titulo}</td>
                            <td>${livro.autor}</td>
                            <td><small>${livro.isbn}</small></td>
                            <td>${livro.anoPublicacao}</td>
                            <td><span class="badge ${livro.quantidadeDisponivel > 0 ? 'bg-success' : 'bg-danger'}">
                                ${livro.quantidadeDisponivel}
                            </span></td>
                            <td><small>${categorias || 'Sem categoria'}</small></td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-warning me-1" onclick="editarLivro(${livro.idLivro})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletarLivro(${livro.idLivro})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                    tbody.appendChild(tr);
                });

                if (livros.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">Nenhum livro encontrado</td></tr>';
                }

                document.getElementById('totalLivros').textContent = livros.length;
                document.getElementById('totalDisponiveis').textContent = disponiveis;
                document.getElementById('totalEmprestados').textContent = livros.length - disponiveis;
                document.getElementById('totalExemplares').textContent = totalExemplares;
            });
    }

    function carregarCategorias() {
        fetch('/api/categorias')
            .then(response => response.json())
            .then(categorias => {
                const select = document.getElementById('selectCategorias');
                select.innerHTML = '';
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.idCategoria;
                    option.textContent = cat.nome;
                    select.appendChild(option);
                });
            });
    }

    function salvarLivro() {
        const form = document.getElementById('formNovoLivro');
        const formData = new FormData(form);

        const selectCat = document.getElementById('selectCategorias');
        const categoriasSelecionadas = Array.from(selectCat.selectedOptions).map(opt => parseInt(opt.value));

        const livro = {
            titulo: formData.get('titulo'),
            autor: formData.get('autor'),
            isbn: formData.get('isbn'),
            anoPublicacao: parseInt(formData.get('anoPublicacao')),
            quantidadeDisponivel: parseInt(formData.get('quantidadeDisponivel')),
            idsCategorias: categoriasSelecionadas
        };

        fetch('/api/livros', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(livro)
        })
            .then(response => {
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalNovoLivro')).hide();
                    form.reset();
                    carregarLivros();
                    alert('Livro criado com sucesso!');
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            })
            .catch(error => alert('Erro: ' + error.message));
    }

    function editarLivro(id) {
        fetch(`/api/livros/${id}`)
            .then(response => response.json())
            .then(livro => {
                document.getElementById('editIdLivro').value = livro.idLivro;
                document.getElementById('editTitulo').value = livro.titulo;
                document.getElementById('editAutor').value = livro.autor;
                document.getElementById('editAno').value = livro.anoPublicacao;
                document.getElementById('editQuantidade').value = livro.quantidadeDisponivel;

                new bootstrap.Modal(document.getElementById('modalEditarLivro')).show();
            });
    }

    function atualizarLivro() {
        const id = document.getElementById('editIdLivro').value;
        const livro = {
            titulo: document.getElementById('editTitulo').value,
            autor: document.getElementById('editAutor').value,
            anoPublicacao: parseInt(document.getElementById('editAno').value),
            quantidadeDisponivel: parseInt(document.getElementById('editQuantidade').value)
        };

        fetch(`/api/livros/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(livro)
        })
            .then(response => {
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalEditarLivro')).hide();
                    carregarLivros();
                    alert('Livro atualizado com sucesso!');
                } else {
                    throw new Error('Erro ao atualizar');
                }
            })
            .catch(error => alert('Erro: ' + error.message));
    }

    function deletarLivro(id) {
        if (confirm('Deseja realmente deletar este livro?')) {
            fetch(`/api/livros/${id}`, {method: 'DELETE'})
                .then(response => {
                    if (response.ok) {
                        alert('Livro deletado!');
                        carregarLivros();
                    }
                });
        }
    }

    // Carregar ao iniciar
    carregarLivros();
    carregarCategorias();
</script>
</body>
</html>
